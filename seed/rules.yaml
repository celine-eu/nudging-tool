rules:
  # --- static / onboarding / seasonal ---
  - id: botanswer
    name: Bot reply
    enabled: true
    family: system
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: always

  - id: welcome
    name: Welcome
    enabled: true
    family: onboarding
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: once

  - id: form
    name: Form reminder
    enabled: true
    family: onboarding
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: weekly

  - id: survey
    name: Survey request
    enabled: true
    family: engagement
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: monthly

  - id: spring
    name: Spring message
    enabled: true
    family: seasonal
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: yearly

  - id: summer
    name: Summer message
    enabled: true
    family: seasonal
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: yearly

  - id: autumn
    name: Autumn message
    enabled: true
    family: seasonal
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: yearly

  - id: winter
    name: Winter message
    enabled: true
    family: seasonal
    type: informative
    severity: info
    version: 1
    definition:
      kind: static_message
      required_facts: []
      dedup_window: yearly

  # --- energy nudges (event-based) ---
  - id: imported_down
    name: Imported ↓
    enabled: true
    family: energy
    type: informative
    severity: info
    version: 1
    definition:
      kind: imported_down
      required_facts: [period, delta_pct, cur, prev]
      dedup_window: daily
      threshold_pct: -5

  - id: imported_up
    name: Imported up
    enabled: true
    family: energy
    type: alert
    severity: warning
    version: 1
    definition:
      kind: imported_up
      required_facts: [time, delta_pct, cur, prev]
      dedup_window: daily
      threshold_pct: 20

  - id: price_up
    name: Price up
    enabled: true
    family: price
    type: alert
    severity: warning
    version: 1
    definition:
      kind: price_up
      required_facts: [time]
      dedup_window: daily

  - id: price_down
    name: Price ↓
    enabled: true
    family: price
    type: informative
    severity: info
    version: 1
    definition:
      kind: price_down
      required_facts: [time]
      dedup_window: daily

  - id: sunny_pros
    name: Sunny (prosumer)
    enabled: true
    family: weather
    type: informative
    severity: info
    version: 1
    definition:
      kind: sunny_pros
      required_facts: [time, from_hour, to_hour]
      dedup_window: daily

  - id: sunny_cons
    name: Sunny (consumer)
    enabled: true
    family: weather
    type: informative
    severity: info
    version: 1
    definition:
      kind: sunny_cons
      required_facts: [time, from_hour, to_hour]
      dedup_window: daily

  - id: extr_event
    name: Extreme event
    enabled: true
    family: weather
    type: alert
    severity: warning
    version: 1
    definition:
      kind: extr_event
      required_facts: [time, from_hour, to_hour, event_type]
      dedup_window: daily

  # ==================================================
  # ==================================================
  # TODO aggiungere i controlli in Engine_service
  # ==================================================
  # ==================================================

  # --- KPI / ratio-based rules ---
  - id: generation_down_monthly_v1
    name: Generation down 60% MoM
    enabled: true
    family: system
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [energy_generation_last_month_avg_ratio]
      conditions:
        - fact_key: energy_generation_last_month_avg_ratio
          op: "<"
          value: 0.40

  - id: selfcons_down_weekly_v1
    name: Self-cons down 15% WoW
    enabled: true
    family: energy
    type: alert
    severity: warning
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: weekly
      required_facts: [energy_selfcons_last_week_avg_ratio]
      conditions:
        - fact_key: energy_selfcons_last_week_avg_ratio
          op: "<"
          value: 0.85

  - id: selfcons_down_monthly_v1
    name: Self-cons down 15% MoM
    enabled: true
    family: energy
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [energy_selfcons_last_month_avg_ratio]
      conditions:
        - fact_key: energy_selfcons_last_month_avg_ratio
          op: "<"
          value: 0.85

  - id: inverter_error_critical_daily_v1
    name: Inverter error (critical)
    enabled: true
    family: system
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: daily
      required_facts: [system_status_error_last_day_total]
      conditions:
        - fact_key: system_status_error_last_day_total
          op: ">="
          value: 1

  - id: inverter_error_minor_weekly_v1
    name: Inverter error (minor)
    enabled: true
    family: system
    type: alert
    severity: warning
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: weekly
      required_facts: [system_status_error_last_week_total]
      conditions:
        - fact_key: system_status_error_last_week_total
          op: ">="
          value: 1

  - id: price_up_weekly_v1
    name: Price up 25% WoW
    enabled: true
    family: price
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: weekly
      required_facts: [price_last_week_avg_ratio]
      conditions:
        - fact_key: price_last_week_avg_ratio
          op: ">"
          value: 1.25

  - id: generation_down_monthly_not_radiation_v1
    name: Generation down 25% (rad stable)
    enabled: true
    family: system
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts:
        - energy_generation_last_month_avg_ratio
        - radiation_ghi_last_month_avg_ratio
      conditions:
        - fact_key: energy_generation_last_month_avg_ratio
          op: "<"
          value: 0.75
        - fact_key: radiation_ghi_last_month_avg_ratio
          op: ">"
          value: 0.95
      logic: AND

  - id: bill_up_monthly_v1
    name: Bill up 15% MoM
    enabled: true
    family: billing
    type: alert
    severity: warning
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [cost_last_month_total_ratio]
      conditions:
        - fact_key: cost_last_month_total_ratio
          op: ">"
          value: 1.15

  - id: bill_down_monthly_v1
    name: Bill down 15% MoM
    enabled: true
    family: billing
    type: informative
    severity: info
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [cost_last_month_total_ratio]
      conditions:
        - fact_key: cost_last_month_total_ratio
          op: "<"
          value: 0.85

  - id: generation_min_down_two_weeks_not_radiation_v1
    name: Min gen down 25% (2w)
    enabled: true
    family: system
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: two_weeks
      required_facts:
        - energy_generation_last_two_weeks_min_ratio
        - radiation_ghi_last_two_weeks_min_ratio
      conditions:
        - fact_key: energy_generation_last_two_weeks_min_ratio
          op: "<"
          value: 0.75
        - fact_key: radiation_ghi_last_two_weeks_min_ratio
          op: ">"
          value: 0.95
      logic: AND

  - id: bill_up_monthly_rootcause_v1
    name: Bill up 15% (root cause)
    enabled: true
    family: billing
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts:
        - cost_last_month_total_ratio
        - radiation_ghi_last_month_avg_ratio
        - energy_selfcons_last_month_avg_ratio
        - price_last_month_avg_ratio
      conditions:
        - fact_key: cost_last_month_total_ratio
          op: ">"
          value: 1.15
        - fact_key: radiation_ghi_last_month_avg_ratio
          op: "<"
          value: 0.99
        - fact_key: energy_selfcons_last_month_avg_ratio
          op: ">"
          value: 0.99
        - fact_key: price_last_month_avg_ratio
          op: "<"
          value: 1.01
      logic: AND

  - id: specific_yield_low_two_weeks_v1
    name: Low specific yield (2w)
    enabled: true
    family: system
    type: alert
    severity: alert
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: two_weeks
      required_facts: [specific_yield_last_two_weeks_avg]
      conditions:
        - fact_key: specific_yield_last_two_weeks_avg
          op: "<"
          value: 750

  # --- INFO rules ---
  - id: imported_energy_info_monthly_v1
    name: Imported info
    enabled: true
    family: energy
    type: alert
    severity: warning
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [event_name]
      conditions:
        - fact_key: event_name
          op: "=="
          value: imported_energy_info

  - id: exported_energy_info_monthly_v1
    name: Exported info
    enabled: true
    family: billing
    type: informative
    severity: info
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [event_name]
      conditions:
        - fact_key: event_name
          op: "=="
          value: exported_energy_info

  - id: ticket_opened_info_v1
    name: Ticket opened
    enabled: true
    family: system
    type: informative
    severity: info
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: daily
      required_facts: [event_name]
      conditions:
        - fact_key: event_name
          op: "=="
          value: ticket_opened

  - id: maintenance_scheduled_info_v1
    name: Maintenance scheduled
    enabled: true
    family: system
    type: informative
    severity: info
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: daily
      required_facts: [event_name]
      conditions:
        - fact_key: event_name
          op: "=="
          value: maintenance_scheduled

  - id: contract_renewal_info_v1
    name: Contract renewal
    enabled: true
    family: system
    type: informative
    severity: info
    version: 1
    definition:
      kind: kpi_conditions
      dedup_window: monthly
      required_facts: [event_name]
      conditions:
        - fact_key: event_name
          op: "=="
          value: contract_renewal